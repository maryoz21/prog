<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Usuarios</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

    <div class="container">
        <header>
            <h1>Gestión de Usuarios</h1>
            <p>Panel de administración CRUD con FastAPI</p>
        </header>

        <section class="filters-bar">
            <div class="form-group">
                <label>Buscar por Nombre</label>
                <input type="text" id="filterName" placeholder="Ej: Carlos...">
            </div>
            <div class="form-group" style="max-width: 120px;">
                <label>Edad Mín.</label>
                <input type="number" id="filterAge" placeholder="0">
            </div>
            <button class="btn btn-search" onclick="cargarUsuarios()">
                <i class="fas fa-search"></i> Buscar
            </button>
            <button class="btn btn-secondary" onclick="limpiarFiltros()" style="width: auto; height: 42px; margin-top:0;">
                <i class="fas fa-eraser"></i>
            </button>
        </section>

        <div class="main-grid">
            
            <aside>
                <div class="card">
                    <h3 id="formTitle"><i class="fas fa-user-plus"></i> Nuevo Usuario</h3>
                    <input type="hidden" id="userId">
                    
                    <div class="form-group">
                        <label for="userName">Nombre Completo</label>
                        <input type="text" id="userName" placeholder="Ingresa el nombre">
                    </div>

                    <div class="form-group">
                        <label for="userDate">Fecha de Nacimiento</label>
                        <input type="date" id="userDate">
                    </div>

                    <button class="btn btn-primary" onclick="guardarUsuario()">
                        <i class="fas fa-save"></i> Guardar Usuario
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">
                        Cancelar
                    </button>
                </div>
            </aside>

            <main>
                <div class="card table-container">
                    <h3><i class="fas fa-users"></i> Listado de Registros</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Fecha Nac.</th>
                                <th style="text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaUsuarios">
                            </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000/users";

        async function cargarUsuarios() {
            const name = document.getElementById('filterName').value;
            const age = document.getElementById('filterAge').value;

            let url = API_URL + "?";
            if (name) url += `search=${name}&`;
            if (age) url += `min_age=${age}`;

            try {
                const response = await fetch(url);
                const users = await response.json();
                renderTable(users);
            } catch (error) {
                console.error("Error:", error);
                alert("Error de conexión. Asegúrate de que el backend (main.py) esté corriendo.");
            }
        }

        function renderTable(users) {
            const tbody = document.getElementById('tablaUsuarios');
            tbody.innerHTML = "";

            if (users.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding: 20px; color: #888;'>No se encontraron usuarios</td></tr>";
                return;
            }

            users.forEach(user => {
                const fila = `
                    <tr>
                        <td>#${user.id}</td>
                        <td style="font-weight: 500;">${user.name}</td>
                        <td>${user.birth_date}</td>
                        <td style="text-align: right;">
                            <button class="action-btn edit-btn" onclick="editar('${user.id}', '${user.name}', '${user.birth_date}')">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="eliminar(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += fila;
            });
        }

        async function guardarUsuario() {
            const id = document.getElementById('userId').value;
            const name = document.getElementById('userName').value;
            const birth_date = document.getElementById('userDate').value;

            if (!name || !birth_date) {
                alert("Por favor completa todos los campos");
                return;
            }

            const data = { name, birth_date };

            // Efecto visual de carga (opcional)
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Procesando...";
            btn.disabled = true;

            try {
                if (id) {
                    await fetch(`${API_URL}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                resetForm();
                cargarUsuarios();
            } catch (e) {
                alert("Error al guardar");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function eliminar(id) {
            if(confirm("¿Estás seguro de eliminar este registro?")) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                cargarUsuarios();
            }
        }

        function editar(id, name, date) {
            document.getElementById('userId').value = id;
            document.getElementById('userName').value = name;
            document.getElementById('userDate').value = date;
            
            const title = document.getElementById('formTitle');
            title.innerHTML = `<i class="fas fa-pen"></i> Editando ID: ${id}`;
            title.style.color = "var(--warning)";
            
            document.getElementById('userName').focus();
        }

        function resetForm() {
            document.getElementById('userId').value = "";
            document.getElementById('userName').value = "";
            document.getElementById('userDate').value = "";
            
            const title = document.getElementById('formTitle');
            title.innerHTML = `<i class="fas fa-user-plus"></i> Nuevo Usuario`;
            title.style.color = "var(--text-color)";
        }

        function limpiarFiltros() {
            document.getElementById('filterName').value = "";
            document.getElementById('filterAge').value = "";
            cargarUsuarios();
        }

        // Inicializar
        cargarUsuarios();
    </script>
</body>
</html>